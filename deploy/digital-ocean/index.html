<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link rel="manifest" href="/manifest.webmanifest"><meta name="theme-color" content="#3eaf7c"><link rel="icon" type="image/png" sizes="16x16" href="/images/ublog.png"><title>DigitalOcean Deployment Guide | μblog docs</title><meta name="description" content="documentation for μblog, a reference web application built with Django and Vue.js"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.23">
    <link rel="preload" href="/django-step-by-step/assets/js/runtime~app.968a41d8.js" as="script"><link rel="preload" href="/django-step-by-step/assets/css/styles.592d94e4.css" as="style"><link rel="preload" href="/django-step-by-step/assets/js/981.12928b34.js" as="script"><link rel="preload" href="/django-step-by-step/assets/js/app.be7711e5.js" as="script">
    <link rel="stylesheet" href="/django-step-by-step/assets/css/styles.592d94e4.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/django-step-by-step/" class=""><img class="logo" src="/django-step-by-step/images/ublog.png" alt="μblog docs"><span class="site-name can-hide">μblog docs</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/django-step-by-step/intro" class="nav-link" aria-label="Introduction"><!--[--><!--]--> Introduction <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Topics"><span class="title">Topics</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Topics"><span class="title">Topics</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/django-step-by-step/topics/twelve-factor-app" class="nav-link" aria-label="Twelve-Factor App"><!--[--><!--]--> Twelve-Factor App <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/django/" class="nav-link" aria-label="Django Application"><!--[--><!--]--> Django Application <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/quasar/" class="nav-link" aria-label="Quasar Application"><!--[--><!--]--> Quasar Application <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/docker-compose/" class="nav-link" aria-label="Docker Compose"><!--[--><!--]--> Docker Compose <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/jwt-authentication/" class="nav-link" aria-label="Authentication"><!--[--><!--]--> Authentication <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/vuepress/" class="nav-link" aria-label="VuePress Documentation"><!--[--><!--]--> VuePress Documentation <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Guide"><span class="title">Guide</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Guide"><span class="title">Guide</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/django-step-by-step/guide/step-by-step/" class="nav-link" aria-label="Step by step guide"><!--[--><!--]--> Step by step guide <!--[--><!--]--></a></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>CI/CD</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/django-step-by-step/guide/ci-cd/github-actions/" class="nav-link" aria-label="GitHub Actions"><!--[--><!--]--> GitHub Actions <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/django-step-by-step/guide/ci-cd/gitlab-ci/" class="nav-link" aria-label="GitLab CI"><!--[--><!--]--> GitLab CI <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Deploy"><span class="title">Deploy</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Deploy"><span class="title">Deploy</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><a href="/django-step-by-step/deploy/overview/" class="nav-link" aria-label="Overview"><!--[--><!--]--> Overview <!--[--><!--]--></a></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/django-step-by-step/deploy/raspi/" class="nav-link" aria-label="Raspberry Pi"><!--[--><!--]--> Raspberry Pi <!--[--><!--]--></a></li><li class="dropdown-subitem"><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="DigitalOcean"><!--[--><!--]--> DigitalOcean <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/django-step-by-step/deploy/aws/overview" class="nav-link" aria-label="AWS Overview"><!--[--><!--]--> AWS Overview <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/django-step-by-step/deploy/aws/docker-swarm-ec2/" class="nav-link" aria-label="Docker Swarm on EC2"><!--[--><!--]--> Docker Swarm on EC2 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/zh/" class="nav-link" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/briancaffey/django-step-by-step" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/django-step-by-step/intro" class="nav-link" aria-label="Introduction"><!--[--><!--]--> Introduction <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Topics"><span class="title">Topics</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Topics"><span class="title">Topics</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/django-step-by-step/topics/twelve-factor-app" class="nav-link" aria-label="Twelve-Factor App"><!--[--><!--]--> Twelve-Factor App <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/django/" class="nav-link" aria-label="Django Application"><!--[--><!--]--> Django Application <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/quasar/" class="nav-link" aria-label="Quasar Application"><!--[--><!--]--> Quasar Application <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/docker-compose/" class="nav-link" aria-label="Docker Compose"><!--[--><!--]--> Docker Compose <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/jwt-authentication/" class="nav-link" aria-label="Authentication"><!--[--><!--]--> Authentication <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/topics/vuepress/" class="nav-link" aria-label="VuePress Documentation"><!--[--><!--]--> VuePress Documentation <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Guide"><span class="title">Guide</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Guide"><span class="title">Guide</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/django-step-by-step/guide/step-by-step/" class="nav-link" aria-label="Step by step guide"><!--[--><!--]--> Step by step guide <!--[--><!--]--></a></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>CI/CD</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/django-step-by-step/guide/ci-cd/github-actions/" class="nav-link" aria-label="GitHub Actions"><!--[--><!--]--> GitHub Actions <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/django-step-by-step/guide/ci-cd/gitlab-ci/" class="nav-link" aria-label="GitLab CI"><!--[--><!--]--> GitLab CI <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Deploy"><span class="title">Deploy</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Deploy"><span class="title">Deploy</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><a href="/django-step-by-step/deploy/overview/" class="nav-link" aria-label="Overview"><!--[--><!--]--> Overview <!--[--><!--]--></a></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/django-step-by-step/deploy/raspi/" class="nav-link" aria-label="Raspberry Pi"><!--[--><!--]--> Raspberry Pi <!--[--><!--]--></a></li><li class="dropdown-subitem"><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="DigitalOcean"><!--[--><!--]--> DigitalOcean <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/django-step-by-step/deploy/aws/overview" class="nav-link" aria-label="AWS Overview"><!--[--><!--]--> AWS Overview <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/django-step-by-step/deploy/aws/docker-swarm-ec2/" class="nav-link" aria-label="Docker Swarm on EC2"><!--[--><!--]--> Docker Swarm on EC2 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/django-step-by-step/zh/" class="nav-link" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/briancaffey/django-step-by-step" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">DigitalOcean Deployment Guide</p><ul class=""><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#digitalocean-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="DigitalOcean Setup"><!--[--><!--]--> DigitalOcean Setup <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#gitlab-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="GitLab Setup"><!--[--><!--]--> GitLab Setup <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#protected-tags" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Protected Tags"><!--[--><!--]--> Protected Tags <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#environment-variables" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Environment Variables"><!--[--><!--]--> Environment Variables <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#dns-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="DNS Setup"><!--[--><!--]--> DNS Setup <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#docker-swarm-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Docker Swarm Setup"><!--[--><!--]--> Docker Swarm Setup <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#install-rex-ray-plugin" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Install REX-Ray Plugin"><!--[--><!--]--> Install REX-Ray Plugin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#initialize-docker-swarm" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Initialize Docker Swarm"><!--[--><!--]--> Initialize Docker Swarm <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#add-traefik-network" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Add traefik network"><!--[--><!--]--> Add traefik network <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#deployment" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Deployment"><!--[--><!--]--> Deployment <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#trigger-a-deployment" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Trigger a deployment"><!--[--><!--]--> Trigger a deployment <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#verify-the-deployment-manually" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Verify the deployment manually"><!--[--><!--]--> Verify the deployment manually <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#run-manual-gitlab-ci-jobs" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Run manual GitLab CI jobs"><!--[--><!--]--> Run manual GitLab CI jobs <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#removing-the-stack" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Removing the stack"><!--[--><!--]--> Removing the stack <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/django-step-by-step/deploy/digital-ocean/#cleaning-up-resources" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Cleaning up resources"><!--[--><!--]--> Cleaning up resources <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="digitalocean-deployment-guide" tabindex="-1"><a class="header-anchor" href="#digitalocean-deployment-guide" aria-hidden="true">#</a> DigitalOcean Deployment Guide</h1><p>This is a short walkthrough of how to deploy this project on DigitalOcean. There are some manual steps, but everything is automated through GitLab CI as much as possible.</p><h2 id="digitalocean-setup" tabindex="-1"><a class="header-anchor" href="#digitalocean-setup" aria-hidden="true">#</a> DigitalOcean Setup</h2><ul><li>Create SSH key for user with Digital Ocean and add it to your account</li><li>Create a project</li><li>Add any size Droplet with Docker 19.03.12 machine image, add the SSH key that you created</li><li>Don&#39;t add any volumes (we will do that automatically with REX-Ray)</li><li>Ceate a DigitOcean Personal Access Token and store it somewhere, we will use it later</li></ul><h2 id="gitlab-setup" tabindex="-1"><a class="header-anchor" href="#gitlab-setup" aria-hidden="true">#</a> GitLab Setup</h2><h3 id="protected-tags" tabindex="-1"><a class="header-anchor" href="#protected-tags" aria-hidden="true">#</a> Protected Tags</h3><p>Go to <code>Settings &gt; Repository &gt; Protected Tags</code> and create a wildcard tag to protect. I use <code>rc*</code> for staging environments and <code>v*</code> for version. When I create a git tag such as <code>rc1.2.3</code>, the GitLab CI pipline will run since I have set the following in <code>gitlab-ci.yml</code>:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">workflow</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">&quot;$CI_COMMIT_TAG =~ /^rc/&quot;</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> always
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="environment-variables" tabindex="-1"><a class="header-anchor" href="#environment-variables" aria-hidden="true">#</a> Environment Variables</h3><p>Add the following environment variables to the cloned GitLab project&#39;s <code>CI/CD &gt; Variables</code> section.</p><p>Make sure the environment variables are all protected since they contain sensitive information.</p><ul><li><p><code>DJANGO_SUPERUSER_EMAIL</code></p></li><li><p><code>DJANGO_SUPERUSER_PASSWORD</code></p></li><li><p><code>DJANGO_SUPERUSER_USERNAME</code></p></li><li><p><code>DOMAIN_NAME</code></p></li></ul><p>I will be using domains from Freenom which are completely free to use, suitable for demonstrations or other types of projects where you don&#39;t want to pay for a <code>.com</code> or other paid domain.</p><p>This is needed in order to create TLS certificates automatically with Traefik, certbot and Let&#39;s Encrypy. Traefik will take care of all of this automatically, all you need to do is set the variable which is referenced in the <code>web</code> service in <code>stack.yml</code> (discussed later on).</p><ul><li><code>READ_REGISTRY_TOKEN</code></li></ul><p>Create a GitLab Personal Access <a href="https://gitlab.com/-/profile/personal_access_tokens" target="_blank" rel="noopener noreferrer">https://gitlab.com/-/profile/personal_access_tokens<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> and add it to this variable.</p><ul><li><code>SSH_PRIVATE_KEY</code></li></ul><p>Add the private SSH key from the SSH key pair created earlier</p><ul><li><p><code>DROPLET_IP</code></p></li><li><p><code>POSTGRES_PASSWORD</code></p></li><li><p><code>SECRET_KEY</code></p></li><li><p><code>DEBUG</code>: set this to the value <code>0</code></p></li></ul><h2 id="dns-setup" tabindex="-1"><a class="header-anchor" href="#dns-setup" aria-hidden="true">#</a> DNS Setup</h2><p>Create an A Record that points to the Droplet IP.</p><p>If you registered <code>mysite.ga</code> and your Droplet IP is <code>123.456.789.10</code>, make sure that you can see the Droplet IP address when you run <code>dig mysite.ga</code> from your terminal. It should contain the following lines:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>;; ANSWER SECTION:
mysite.ga.		3600	IN	A	123.456.789.10
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="docker-swarm-setup" tabindex="-1"><a class="header-anchor" href="#docker-swarm-setup" aria-hidden="true">#</a> Docker Swarm Setup</h2><p>SSH into the Droplet:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ssh -i ~/.ssh/your-key root@123.456.789.10
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="install-rex-ray-plugin" tabindex="-1"><a class="header-anchor" href="#install-rex-ray-plugin" aria-hidden="true">#</a> Install REX-Ray Plugin</h3><p>Using the DigitalOcean personal access token you create earlier (NOT the GitLab personal access token), run the following command:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker plugin install rexray/dobs DOBS_TOKEN=your-token-123abc DOBS_REGION=nyc1 LINUX_VOLUME_FILEMODE=0775
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Replacing <code>your-token-123abc</code> with the actual token value.</p><p>Confirm that you would like to install by pressing <code>y</code>.</p><p>Verify that the plugin has been installed by running:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker plugin lsID                  NAME                 DESCRIPTION                               ENABLED
2acafbb251e4        rexray/dobs:latest   REX-Ray for Digital Ocean Block Storage   true
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Note: volume names must be unique across your DigitalOcean account</strong></p><h3 id="initialize-docker-swarm" tabindex="-1"><a class="header-anchor" href="#initialize-docker-swarm" aria-hidden="true">#</a> Initialize Docker Swarm</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker swarm init --advertise-addr 123.456.789.10
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>If you are going to use only one node for your swarm cluster, you can ignore the output of this command for now.</p><h3 id="add-traefik-network" tabindex="-1"><a class="header-anchor" href="#add-traefik-network" aria-hidden="true">#</a> Add traefik network</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker network create --driver=overlay traefik-public
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="deployment" tabindex="-1"><a class="header-anchor" href="#deployment" aria-hidden="true">#</a> Deployment</h2><p>At this point, everything should be ready to go for the initial deployment.</p><h3 id="trigger-a-deployment" tabindex="-1"><a class="header-anchor" href="#trigger-a-deployment" aria-hidden="true">#</a> Trigger a deployment</h3><p>Simply create a git tag and push it to the GitLab repository:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>git tag rc0.0.1
git push origin rc0.0.1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Alternatively, you can annotate the tag by using the <code>-a</code> flag:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>git tag -a rc0.0.1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>If you protected all tags starting with <code>rc</code> using an <code>rc*</code> wildcard for protected tags as mentioned above, only you (or whever you selected) will be able to push tags starting with <code>rc</code> that will trigger a deployment.</p><p>When you push this tag, the GitLab CI jobs defined in <code>.gitlab-ci.yml</code> will run:</p><ul><li><code>build-backend</code></li><li><code>build-nginx</code></li><li><code>docker-stack-deploy</code></li></ul><p>The first two jobs build images, tag them with the current short git commit SHA-1 checksum and then push them to your private GitLab registry. You don&#39;t need to set up this registry, they are available by default for every GitLab project, and the environment variable <code>CI_REGISTRY_IMAGE</code> is automatically set in each GitLab CI job.</p><p>The last job, <code>docker-stack-deploy</code>, deploys a docker swarm stack to the swarm cluster that you set up earlier. This is done securly over SSH. The <code>.add-ssh-key</code> job template is included in the <code>docker-stack-deploy</code> which gives the CI job SSH access to the swarm cluster manager.</p><h3 id="verify-the-deployment-manually" tabindex="-1"><a class="header-anchor" href="#verify-the-deployment-manually" aria-hidden="true">#</a> Verify the deployment manually</h3><p>Here are a few commands you can use to verify the deployment:</p><p>Check running services:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                                                              PORTS
u509qaymojjx        my-stack_backend    replicated          1/1                 registry.gitlab.com/briancaffey/sec-filings-app/backend:1a659c95
myqiorvtif9p        my-stack_celery     replicated          1/1                 registry.gitlab.com/briancaffey/sec-filings-app/backend:1a659c95
uy77yz7ctpxe        my-stack_postgres   replicated          1/1                 postgres:latest
l3j0bbyfq5vu        my-stack_redis      replicated          1/1                 redis:alpine
bixr5yj152pd        my-stack_traefik    replicated          1/1                 traefik:v2.3.4                                                     *:80-&gt;80/tcp, *:443-&gt;443/tcp
uq58zduqaesj        my-stack_web        replicated          1/1                 registry.gitlab.com/briancaffey/sec-filings-app/nginx:1a659c95
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Check volumes:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker volume ls
rexray/dobs:latest   osdbackendassets
rexray/dobs:latest   osdletsencrypt
rexray/dobs:latest   osdpgdata
rexray/dobs:latest   osdredisdata
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Check that the certificate was created successfully:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker exec -it $(docker ps -q -f name=&quot;traefik&quot;) cat /letsencrypt/acme.json
{
  &quot;letsencryptresolver&quot;: {
    &quot;Account&quot;: {
      &quot;Email&quot;: &quot;your@email.com&quot;,
      &quot;Registration&quot;: {
        &quot;body&quot;: {
          &quot;status&quot;: &quot;valid&quot;,
          &quot;contact&quot;: [
            &quot;mailto:your@email.com&quot;
          ]
        },
        &quot;uri&quot;: &quot;https://acme-v02.api.letsencrypt.org/acme/acct/104180270&quot;
      },
      &quot;PrivateKey&quot;: &quot;MIIJKQ.......
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>If a service is not starting, you can get more information by running:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker service ps --no-trunc u509qaymojjx
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Where <code>u509qaymojjx</code> is the id of the service obtained from <code>docker service ls</code>.</p><h3 id="run-manual-gitlab-ci-jobs" tabindex="-1"><a class="header-anchor" href="#run-manual-gitlab-ci-jobs" aria-hidden="true">#</a> Run manual GitLab CI jobs</h3><p>There are still a few things that must be done manually when we first release:</p><ul><li>run <code>./manage.py collectstatc</code> to move static folders into our the volume that is shared between nginx, the Django webserver and celery</li><li>run <code>./manage.py migrate</code> to apply the database migration files in order to create the database tables specified in your project&#39;s migration files</li><li>run <code>./manage.py createsuperuser</code> to create an administrative user that we can use to access the Django admin.</li></ul><p>The <code>.gitlab-ci.yml</code> file defines three additional jobs that are set to only run manually, which is whenever you press the &quot;Play&quot; button on a pipeline job. Once you push a tag and the first two stages (<code>build</code> and <code>deploy</code>) complete, you will be able to run these manual commands. However, you should verify that the <code>backend</code> service has been created and that it is running. You will see the logs from these jobs in the GitLab CI job logs, so if anything goes wrong it should be easy to figure out what may be causing a job failure.</p><p>Any time you add static files or add something to <code>INSTALLED_APPS</code> that includes static files (like Django REST Framework), you will need to trigger the <code>collectstatic</code> manaul job again.</p><p>Also, when you add new migration files, you will need to run the <code>migrate</code> manual job as well.</p><h2 id="removing-the-stack" tabindex="-1"><a class="header-anchor" href="#removing-the-stack" aria-hidden="true">#</a> Removing the stack</h2><p>If you wish to tear everything down, the easiest way is to delete the Droplet and then manually delete the volumes. If you run <code>docker stack rm my-stack</code>, note that the volumes will persist.</p><h2 id="cleaning-up-resources" tabindex="-1"><a class="header-anchor" href="#cleaning-up-resources" aria-hidden="true">#</a> Cleaning up resources</h2><p>One other thing to be aware of is older tags in your GitLab CI repository will not be automatically removed. You may want to periodically remove these, or use the GitLab API to do so. The assets created for the frontend will persist on GitLab for 30 days by default. You don&#39;t need these files once they are built into the docker image, so you can change the settings for these artififacts if you wish to do so.</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/briancaffey/django-step-by-step/edit/main/vuepress-docs/docs/deploy/digital-ocean/README.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub"><!--[--><!--]--> Edit this page on GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">9/11/2022, 3:16:43 AM</span></div><!----></footer><nav class="page-nav"><p class="inner"><!----><span class="next"><a href="/django-step-by-step/deploy/aws" class="nav-link" aria-label="/deploy/aws"><!--[--><!--]--> /deploy/aws <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/django-step-by-step/assets/js/runtime~app.968a41d8.js" defer></script><script src="/django-step-by-step/assets/js/981.12928b34.js" defer></script><script src="/django-step-by-step/assets/js/app.be7711e5.js" defer></script>
  </body>
</html>
